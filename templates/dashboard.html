{% extends "base.html" %}

{% block title %}Dashboard - Digital Dear Diary{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Quote Section -->
        <div class="quote-section">
            <h4><i class="fas fa-quote-left text-primary me-2"></i>Today's Inspiration</h4>
            <p class="mb-0" id="daily-quote">"Every day is a new beginning. Take a deep breath and start again."</p>
        </div>

        <!-- New Entry Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-pen-fancy text-primary me-2"></i>New Entry
                </h5>
                
                <div class="mb-3">
                    <label for="entry-content" class="form-label">What's on your mind today?</label>
                    <textarea class="form-control" id="entry-content" rows="6" placeholder="Start writing or use voice input..."></textarea>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button type="button" class="voice-btn" id="voice-btn" title="Voice Input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <select class="form-select" id="theme-select" style="width: auto;">
                            <option value="light">Light Theme</option>
                            <option value="dark">Dark Theme</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="save-btn">
                        <i class="fas fa-save me-2"></i>Save Entry
                    </button>
                </div>
                
                <div id="emotion-display" class="mt-3" style="display: none;">
                    <span class="badge emotion-badge" id="emotion-badge"></span>
                    <span class="ms-2" id="emotion-text"></span>
                </div>
            </div>
        </div>

        <!-- Recent Entries -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-history text-primary me-2"></i>Recent Entries
                </h5>
                <div id="entries-container">
                    {% for entry in entries %}
                    <div class="entry-item border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <p class="mb-1">{{ entry.content[:200] }}{% if entry.content|length > 200 %}...{% endif %}</p>
                                <small class="text-muted">{{ entry.date_created.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <span class="badge emotion-badge emotion-{{ entry.emotion.lower() }}">{{ entry.emotion }}</span>
                                <button class="btn btn-sm btn-outline-danger delete-entry" data-entry-id="{{ entry.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Stats Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-bar text-primary me-2"></i>Your Stats
                </h5>
                <div class="row text-center">
                    <div class="col-6">
                        <h3 class="text-primary">{{ entries|length }}</h3>
                        <small class="text-muted">Total Entries</small>
                    </div>
                    <div class="col-6">
                        <h3 class="text-success">{{ entries|selectattr('emotion', 'equalto', 'Happy')|list|length }}</h3>
                        <small class="text-muted">Happy Days</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-bolt text-primary me-2"></i>Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="clearEntry()">
                        <i class="fas fa-eraser me-2"></i>Clear Entry
                    </button>
                    <button class="btn btn-outline-success" onclick="exportEntries()">
                        <i class="fas fa-download me-2"></i>Export Entries
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let recognition;
let isRecording = false;

// Initialize speech recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = true;
    
    recognition.onstart = function() {
        isRecording = true;
        document.getElementById('voice-btn').classList.add('recording');
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-stop"></i>';
    };
    
    recognition.onresult = function(event) {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                transcript += event.results[i][0].transcript;
            }
        }
        if (transcript) {
            document.getElementById('entry-content').value += transcript + ' ';
        }
    };
    
    recognition.onend = function() {
        isRecording = false;
        document.getElementById('voice-btn').classList.remove('recording');
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        isRecording = false;
        document.getElementById('voice-btn').classList.remove('recording');
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
    };
}

// Voice button functionality
document.getElementById('voice-btn').addEventListener('click', function() {
    if (!recognition) {
        alert('Speech recognition is not supported in your browser.');
        return;
    }
    
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
});

// Save entry functionality
document.getElementById('save-btn').addEventListener('click', function() {
    const content = document.getElementById('entry-content').value.trim();
    const theme = document.getElementById('theme-select').value;
    
    if (!content) {
        alert('Please enter some content before saving.');
        return;
    }
    
    fetch('/save-entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content,
            theme: theme
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('entry-content').value = '';
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the entry.');
    });
});

// Delete entry functionality
document.querySelectorAll('.delete-entry').forEach(button => {
    button.addEventListener('click', function() {
        const entryId = this.getAttribute('data-entry-id');
        if (confirm('Are you sure you want to delete this entry?')) {
            fetch(`/delete-entry/${entryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.closest('.entry-item').remove();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the entry.');
            });
        }
    });
});

// Theme switching
document.getElementById('theme-select').addEventListener('change', function() {
    const theme = this.value;
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
    } else {
        document.body.classList.remove('dark-theme');
    }
});

// Clear entry
function clearEntry() {
    if (confirm('Are you sure you want to clear the current entry?')) {
        document.getElementById('entry-content').value = '';
    }
}

// Export entries
function exportEntries() {
    fetch('/get-entries')
    .then(response => response.json())
    .then(entries => {
        const dataStr = JSON.stringify(entries, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'diary-entries.json';
        link.click();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while exporting entries.');
    });
}

// Daily quote rotation
const quotes = [
    "Every day is a new beginning. Take a deep breath and start again.",
    "The only way to do great work is to love what you do.",
    "Life is what happens when you're busy making other plans.",
    "The future belongs to those who believe in the beauty of their dreams.",
    "Success is not final, failure is not fatal: it is the courage to continue that counts."
];

function updateQuote() {
    const quoteElement = document.getElementById('daily-quote');
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
    quoteElement.textContent = `"${randomQuote}"`;
}

// Update quote on page load
updateQuote();
</script>
{% endblock %} 